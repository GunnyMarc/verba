{% extends "base.html" %}
{% block title %}Verba â€” Video Transcription{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Video Transcription</h1>
    <p class="subtitle">Upload a video file to extract and transcribe speech</p>
</div>

<div class="card form-card">
    <form hx-post="/videotr/upload"
          hx-target="#result-area"
          hx-swap="innerHTML"
          hx-encoding="multipart/form-data"
          hx-indicator="#upload-indicator">

        <div class="form-row">
            <label class="toggle-label">
                <input type="checkbox" name="batch_process" value="on"
                       onchange="document.getElementById('file-input-group').style.display = this.checked ? 'none' : 'block'; document.getElementById('batch-input-group').style.display = this.checked ? 'block' : 'none'">
                <span class="toggle-text">Batch Process</span>
                <span class="toggle-hint">Process all video files in a directory</span>
            </label>
        </div>

        <div id="form-error" class="alert alert--error" style="display:none"></div>

        <div id="file-input-group" class="form-row">
            <label class="form-label" for="file">Video Input File</label>
            <input type="file" id="file" name="file"
                   accept=".mov,.mp4,.mkv,.mpeg,.avi,.webm"
                   class="file-input">
            <span class="form-hint">Supported: {{ supported_formats }}</span>
        </div>

        <div id="batch-input-group" class="form-row" style="display:none">
            <label class="form-label" for="input_dir">Video Input Directory</label>
            <div class="input-with-browse">
                <input type="text" id="input_dir" name="input_dir"
                       value="{{ settings.video_input_dir }}"
                       class="form-input">
                <button type="button" class="btn btn--browse"
                        onclick="document.getElementById('browse-modal').style.display='flex'; htmx.ajax('GET', '/videotr/browse?path=' + encodeURIComponent(document.getElementById('input_dir').value) + '&target=input_dir', '#browse-modal-content')">
                    Browse
                </button>
            </div>
        </div>

        <div class="form-row">
            <label class="form-label" for="output_dir">Video File Output</label>
            <div class="input-with-browse">
                <input type="text" id="output_dir" name="output_dir"
                       value="{{ settings.video_output_dir }}"
                       class="form-input">
                <button type="button" class="btn btn--browse"
                        onclick="document.getElementById('browse-modal').style.display='flex'; htmx.ajax('GET', '/videotr/browse?path=' + encodeURIComponent(document.getElementById('output_dir').value) + '&target=output_dir', '#browse-modal-content')">
                    Browse
                </button>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-row">
                <label class="form-label" for="model">Whisper Model</label>
                <select id="model" name="model" class="form-select">
                    {% for m in whisper_models %}
                    <option value="{{ m }}" {% if m == settings.whisper_model %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label class="form-label" for="style">Markdown Style</label>
                <select id="style" name="style" class="form-select">
                    {% for s in markdown_styles %}
                    <option value="{{ s }}" {% if s == settings.markdown_style %}selected{% endif %}>{{ s }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <label class="form-label" for="language">Language</label>
                <input type="text" id="language" name="language"
                       value="{{ settings.language }}"
                       placeholder="auto"
                       class="form-input">
                <span class="form-hint">ISO 639-1 code or "auto"</span>
            </div>

            <div class="form-row">
                <label class="form-label" for="device">Device</label>
                <select id="device" name="device" class="form-select">
                    {% for d in device_choices %}
                    <option value="{{ d }}" {% if d == settings.device %}selected{% endif %}>{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <label class="toggle-label">
                <input type="checkbox" name="include_metadata" value="on"
                       {% if settings.include_metadata %}checked{% endif %}>
                <span class="toggle-text">Include Metadata</span>
            </label>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn--primary">
                <span class="btn-text">Transcribe</span>
                <span id="upload-indicator" class="htmx-indicator spinner"></span>
            </button>
        </div>
    </form>
</div>

<div id="result-area"></div>

<div id="browse-modal" class="browse-modal" style="display:none">
    <div class="browse-modal-dialog" id="browse-modal-content"></div>
</div>

<script>
document.body.addEventListener('htmx:confirm', function(evt) {
    var form = evt.target.closest('form');
    if (!form || !form.matches('[hx-post="/videotr/upload"]')) return;

    var errorDiv = document.getElementById('form-error');
    var fileGroup = document.getElementById('file-input-group');
    var batchCheckbox = form.querySelector('input[name="batch_process"]');
    var isBatch = batchCheckbox && batchCheckbox.checked;

    // Single mode: check file input
    if (!isBatch && fileGroup.style.display !== 'none') {
        var fileInput = document.getElementById('file');
        if (!fileInput.value) {
            errorDiv.textContent = 'Please select a video input file.';
            errorDiv.style.display = 'block';
            evt.preventDefault();
            return;
        }
    }

    // Check output dir
    var outputDir = document.getElementById('output_dir');
    if (!outputDir.value.trim()) {
        errorDiv.textContent = 'Please select a video file output location.';
        errorDiv.style.display = 'block';
        evt.preventDefault();
        return;
    }

    errorDiv.style.display = 'none';
});

// Auto-hide error when user interacts with the fields
document.getElementById('file').addEventListener('change', function() {
    document.getElementById('form-error').style.display = 'none';
});
document.getElementById('output_dir').addEventListener('input', function() {
    document.getElementById('form-error').style.display = 'none';
});
document.getElementById('input_dir').addEventListener('input', function() {
    document.getElementById('form-error').style.display = 'none';
});
</script>
{% endblock %}
